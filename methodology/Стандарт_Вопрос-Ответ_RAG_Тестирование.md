# Стандарт "Вопрос-Ответ" для тестирования RAG-системы

---

## 1. Параметры векторизации системы

**Модель эмбеддингов:** nomic-embed-text (через Ollama)  
**Размер чанка:** 350 слов  
**Перекрытие (overlap):** 70 слов  
**Размерность вектора:** определяется моделью nomic-embed-text

---

## 2. Параметры генерации ответов

**Модель:** DeepSeek Chat (через Polza.ai API)  
**Temperature:** 0.0 (максимальная точность для формул)  
**Top-p:** 0.95  
**Max tokens:** 2000  
**Таймаут:** 60 секунд

---

## 3. Алгоритм поиска (Hybrid Search)

**Semantic search:** векторный поиск по косинусной близости  
**Keyword boosting:** +0.3 за совпадение документа (Справочник, Золотой Стандарт)  
**Formula boosting:** +0.25 за наличие формул в чанке  
**Definition boosting:** +0.5 за чанки с определениями  
**Small document boost:** +0.05 для документов <100 чанков  
**Score threshold:** 0.60 (минимальный порог релевантности)  
**Context expansion:** ±1 соседний чанк для формул

---

## 4. Стандартный формат тестирования

### Типы вопросов для проверки:

#### A. Определения (дефиниции)
- Что такое [термин]?
- Определение [термина]
- Что это [термин]?

#### B. Формулы и расчёты
- Как рассчитать [показатель]?
- Формула для [показателя]
- Как считать [метрику]?

#### C. Практические задачи
- Что делать если [проблема]?
- Как улучшить [показатель]?
- Как решить [ситуацию]?

#### D. Расчёты с данными
- Посчитай [показатель] при данных: [числа]

---

## 5. ПРИМЕРЫ СТАНДАРТНЫХ ТЕСТОВ

### Тест №1: Определение (базовый)

**Вопрос:**
```
Что такое нормочас?
```

**Ожидаемый ответ (структура):**
```
[Определение из документа дословно]

Где:
- [переменная 1] - расшифровка
- [переменная 2] - расшифровка

Нормы:
- [категория 1]: [значения]
- [категория 2]: [значения]

Вопросы:
1. [уточняющий вопрос 1]
2. [уточняющий вопрос 2]
```

**Критерии проверки:**
- ✅ Дословная цитата определения из документа
- ✅ Формула указана без markdown (**)
- ✅ Все переменные расшифрованы
- ✅ Указаны нормативные значения
- ✅ 2-3 уточняющих вопроса
- ❌ НЕТ выдуманной информации
- ❌ НЕТ фраз "В документе", "Согласно контексту"

---

### Тест №2: Формула (расширенный)

**Вопрос:**
```
Как рассчитать валовую выручку клиники?
```

**Ожидаемый ответ (структура):**
```
ВВклиники = Кзаг * НЧ * tраб * n

Где:
- Кзаг - коэффициент загрузки врачей
- НЧ - средний нормочас врачей
- tраб - рабочее время врачей
- n - количество врачей

Для расчёта нужны данные:
1. [список данных]

Пример расчёта:
[пошаговый расчёт, если есть данные]

Вопросы:
1. Как рассчитать коэффициент загрузки?
2. Какие нормы нормочаса для терапевтов?
```

**Критерии проверки:**
- ✅ Формула указана точно (НЕ в markdown)
- ✅ Каждая переменная объяснена
- ✅ Указаны требуемые данные для расчёта
- ✅ Приведены нормы (если есть в документе)
- ❌ НЕТ подстановки выдуманных чисел

---

### Тест №3: Расчёт с данными (проверка вычислений)

**Вопрос:**
```
Посчитай нормочас врача, если его валовая выручка 600 000 рублей, 
а время работы с пациентами 80 часов.
```

**Ожидаемый ответ (структура):**
```
Формула: НЧ = ВВ / tзаг

Подстановка данных:
НЧ = 600 000 руб / 80 часов

Расчёт:
НЧ = 7 500 руб/час

Интерпретация:
[сравнение с нормами для разных специализаций]

Вопросы:
1. Как увеличить нормочас врача?
2. Влияет ли нормочас на зарплату?
```

**Критерии проверки:**
- ✅ Использована точная формула из документа
- ✅ Данные правильно подставлены
- ✅ ВЫПОЛНЕНО арифметическое вычисление
- ✅ Результат интерпретирован (сравнение с нормами)
- ❌ НЕТ отказа от вычисления ("я не могу считать")

---

### Тест №4: Неполные данные (проверка уточнения)

**Вопрос:**
```
Посчитай валовую выручку клиники, если работают 3 врача по 160 часов.
```

**Ожидаемый ответ (структура):**
```
Для расчёта валовой выручки по формуле ВВклиники = Кзаг * НЧ * tраб * n нужны:

Есть данные:
- n = 3 врача
- tраб = 160 часов каждый

Не хватает данных:
- Кзаг (коэффициент загрузки) - доля времени, когда врач занят с пациентами
- НЧ (нормочас) - средний нормочас врачей

Укажите:
1. Коэффициент загрузки в % (например, 80%)
2. Средний нормочас врачей в рублях

По умолчанию для терапевтов:
- Кзаг = 80% (0.8)
- НЧ = 7 500 руб/час

Хотите использовать эти значения?
```

**Критерии проверки:**
- ✅ Чётко указано, каких данных не хватает
- ✅ Объяснено, зачем нужна каждая переменная
- ✅ Предложены значения по умолчанию из норм
- ❌ НЕТ расчёта с выдуманными данными
- ❌ НЕТ отказа без объяснения

---

### Тест №5: Практическая задача

**Вопрос:**
```
Что делать, если низкая конверсия из консультации в лечение?
```

**Ожидаемый ответ (структура):**
```
[Определение показателя из документа]

Формула для диагностики:
ОТдок = начатые лечения / проведенные консультации

Шаги решения:
1. Измерить текущий ОТдок по формуле
2. Сравнить с нормой: [норма из документа]
3. Если ниже нормы, проверить:
   - [конкретный фактор 1]
   - [конкретный фактор 2]
   - [конкретный фактор 3]
4. Внедрить контроль: [конкретная рекомендация]

Вопросы:
1. Какие факторы влияют на ОТдок?
2. Как обучить врачей увеличивать конверсию?
```

**Критерии проверки:**
- ✅ Дано определение проблемы
- ✅ Указана формула для диагностики
- ✅ Предложены КОНКРЕТНЫЕ шаги решения (не общие слова)
- ✅ Упомянуты нормы/целевые значения
- ❌ НЕТ абстрактных советов без формул
- ❌ НЕТ рекомендаций, не основанных на документе

---

## 6. Метрики для оценки качества

### Для методолога:

1. **Точность (Accuracy):** ответ содержит только информацию из документов (0-100%)
2. **Полнота (Completeness):** ответ охватывает все аспекты вопроса (0-100%)
3. **Формат (Format):** ответ следует структуре без markdown (ДА/НЕТ)
4. **Вычисления (Calculations):** при наличии данных выполнены расчёты (ДА/НЕТ)
5. **Уточнения (Follow-up):** наличие 2-3 релевантных вопросов (ДА/НЕТ)
6. **Галлюцинации (Hallucinations):** количество выдуманных фактов (0 = отлично)

---

## 7. Шаблон для тестирования

```
ТЕСТ №___: [Тип вопроса]
Категория: [Определение / Формула / Расчёт / Практика]
Документ: [Справочник / Золотой Стандарт / Директор]

ВОПРОС:
[Текст вопроса]

ОЖИДАЕМЫЕ ЭЛЕМЕНТЫ ОТВЕТА:
□ Определение/Формула из документа
□ Расшифровка переменных
□ Нормативные значения
□ Пошаговые вычисления (если применимо)
□ Конкретные рекомендации (если применимо)
□ 2-3 уточняющих вопроса

НЕДОПУСТИМО:
□ Markdown форматирование (**, ##, *)
□ Фразы "в документе", "согласно контексту"
□ Выдуманные данные или нормы
□ Отказ от вычислений при наличии данных

ОЦЕНКА:
Точность: ___/100
Полнота: ___/100
Формат: ДА/НЕТ
Вычисления: ДА/НЕТ/N/A
Уточнения: ДА/НЕТ
Галлюцинации: ___

ПРИМЕЧАНИЯ:
[Комментарии методолога]
```

---

## Заключение

Этот стандарт позволит систематически проверять качество работы RAG-системы на разных типах вопросов.

### Как использовать:

1. **Выберите тип вопроса** из категорий A-D
2. **Задайте вопрос** системе
3. **Сравните ответ** с ожидаемой структурой
4. **Оцените по критериям** проверки
5. **Заполните метрики** качества
6. **Документируйте результаты** в шаблоне

### Частота тестирования:

- **После изменений в промпте:** полное тестирование всех 5 тестов
- **После добавления новых документов:** выборочное тестирование
- **Еженедельно:** 2-3 случайных теста для контроля качества
- **Перед деплоем:** полное регрессионное тестирование

### Пороговые значения для production:

- Точность: ≥ 90%
- Полнота: ≥ 85%
- Формат: 100% соответствие
- Галлюцинации: 0 фактов

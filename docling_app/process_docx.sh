#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Å–µ—Ö DOCX —Ñ–∞–π–ª–æ–≤

echo "============================================================"
echo "üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ DOCX —Ñ–∞–π–ª–æ–≤"
echo "============================================================"

# –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª
files=(
    "/documents/–ü–ò–†—ã ‚Ññ1,‚Ññ2,‚Ññ3_07.07.2025_–≥–æ—Ç–æ–≤–æ.docx"
    "/documents/–ü–ò–†—ã ‚Ññ10 –∏ –°–£_09.07.2025_–≥–æ—Ç–æ–≤–æ.docx"
    "/documents/–ü–ò–†—ã ‚Ññ4,‚Ññ5,‚Ññ6_09.07.2025_–≥–æ—Ç–æ–≤–æ.docx"
    "/documents/–ü–ò–†—ã ‚Ññ7,‚Ññ8,‚Ññ9_08.07.2025_–≥–æ—Ç–æ–≤–æ.docx"
)

total=${#files[@]}
current=0

for docx_file in "${files[@]}"; do
    current=$((current + 1))
    filename=$(basename "$docx_file")
    
    echo ""
    echo "============================================================"
    echo "üìÑ [$current/$total] –û–±—Ä–∞–±–æ—Ç–∫–∞: $filename"
    echo "============================================================"
    
    # –®–∞–≥ 1: –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è DOCX -> Markdown
    echo ""
    echo "1Ô∏è‚É£  –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è DOCX ‚Üí Markdown..."
    python /app/process_documents.py "$docx_file"
    
    if [ $? -ne 0 ]; then
        echo "   ‚ùå –û—à–∏–±–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏!"
        continue
    fi
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–º—è markdown —Ñ–∞–π–ª–∞
    md_filename=$(basename "$docx_file" .docx).md
    md_file="/shared/processed/$md_filename"
    
    echo "   ‚úÖ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞: $md_filename"
    
    # –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ –≤–µ–∫—Ç–æ—Ä–æ–≤
    echo ""
    echo "2Ô∏è‚É£  –°–æ–∑–¥–∞–Ω–∏–µ –≤–µ–∫—Ç–æ—Ä–æ–≤ (chunk_size=350, overlap=70)..."
    python /app/create_embeddings.py "$md_file"
    
    if [ $? -ne 0 ]; then
        echo "   ‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤–µ–∫—Ç–æ—Ä–æ–≤!"
    else
        echo "   ‚úÖ –í–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
    fi
    
    echo ""
done

echo "============================================================"
echo "‚ú® –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo "============================================================"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
echo ""
echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤..."
python -c "import requests; r = requests.get('http://qdrant-docling:6333/collections/documents'); print(f'   ‚úÖ –í—Å–µ–≥–æ –≤–µ–∫—Ç–æ—Ä–æ–≤ –≤ –±–∞–∑–µ: {r.json()[\"result\"][\"points_count\"]}')" 2>/dev/null || echo "   ‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–µ–∫—Ç–æ—Ä–æ–≤"
